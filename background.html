<script type="text/javascript" src="js/jquery-1.6.2.min.js"> </script>
<script type="text/javascript" src="js/jquery.inc.js"></script>
<script type="text/javascript" src="js/function.js"></script>
<script type="text/javascript" src="js/putio.js"></script>
<script>
    //"selection",
    function extract_url(url){
        var regex = /([\w]+:\/\/[\w-?\%&;#~=\.\/\@\:\[\]\(\)\{\}\|]+[\w\/\[\]\(\)\{\}])/gi;
        var urls = url.match(regex)

        if (!urls){
            var notification = webkitNotifications.createNotification(
                        'img/icon128.png',
                        'Please only enter links starting with: http:// https:// ftp://' ,
                        ''
                    );
                        notification.show();
                        setTimeout( function () {  notification.cancel(); }, 4000);
                return;
            }

        return urls
    }


    function sendtoputio(url, folder_id){
        var urls=extract_url(url)
        Putio.Url.analyze(urls,function(data){
            var results=data.response.results.items;
            var good_urls = [];
            $.each(results.error,function(index, value){
                var notification = webkitNotifications.createNotification(
                'img/icon128.png',
                value.url,
                value.error
            );
                notification.show();
                setTimeout( function () {  notification.cancel(); }, 4000);
            })
            $.each(results.singleurl,function(index, value){
                good_urls.push(value.url);
            })
            Putio.Transfer.add(good_urls,folder_id,function(data){
                $.each(data.response.results,function(index, value){
                    var notification = webkitNotifications.createNotification(
                        'img/icon128.png',
                        value.name,
                        'is '+value.status
                    );
                        notification.show();
                        setTimeout( function () {  notification.cancel(); }, 4000);
                })
            })
        })
    }


    function folderlist(folder,parent_tab_id){
        var contexts = ["selection","link"];
        if(folder.dirs[0]){
            chrome.contextMenus.create({"parentId": parent_tab_id,"title": "/","contexts":contexts,
                "onclick": function(data) {
                    if(data.linkUrl)var url=data.linkUrl
                    else var url=data.selectionText
                    sendtoputio(url,folder.id);
                }
            });
        }
        $.each(folder.dirs,function(index, value){
            var parent_id=chrome.contextMenus.create({"parentId": parent_tab_id,"title": value.name,"contexts":contexts,
                "onclick": function(data) {
                    if(data.linkUrl)var url=data.linkUrl
                    else var url=data.selectionText
                    sendtoputio(url,value.id);
                }
            });
            folderlist(value,parent_id);
        })

    };


    Putio.File.dirmap(function(data){
        var results=data.response.results;
        var contexts = ["selection","link"];
        var parent_tab_id=chrome.contextMenus.create({"title": "Send to Put.io","contexts":contexts,
            "onclick": function(data) {
                if(data.linkUrl)var url=data.linkUrl
                else var url=data.selectionText
                sendtoputio(url,'0');
            }});
        folderlist(results,parent_tab_id);
    });
</script>